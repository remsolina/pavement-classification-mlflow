# ðŸš€ MLflow Local CI/CD Makefile
# 
# This Makefile provides convenient commands for running tests,
# CI/CD pipeline, and development tasks locally.
#
# Usage:
#   make help          # Show this help
#   make test          # Run all tests
#   make ci            # Run full CI/CD pipeline
#   make setup         # Setup development environment

.PHONY: help test unit-test integration-test ci setup clean lint format docker-test

# Default target
.DEFAULT_GOAL := help

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
BOLD := \033[1m
NC := \033[0m # No Color

help: ## ðŸ“‹ Show this help message
	@echo "$(BOLD)ðŸš€ MLflow Local CI/CD Commands$(NC)"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(BLUE)%-20s$(NC) %s\n", $$1, $$2}'

# ===================================================================
# ðŸ§ª TESTING COMMANDS
# ===================================================================

test: ## ðŸ§ª Run all tests (unit + integration)
	@echo "$(BOLD)ðŸ§ª Running all tests...$(NC)"
	python -m pytest tests/ -v

unit-test: ## ðŸ”¬ Run unit tests only
	@echo "$(BOLD)ðŸ”¬ Running unit tests...$(NC)"
	python -m pytest tests/unit/ -v

integration-test: ## ðŸ”— Run integration tests only
	@echo "$(BOLD)ðŸ”— Running integration tests...$(NC)"
	python -m pytest tests/integration/ -v

test-coverage: ## ðŸ“Š Run tests with coverage report
	@echo "$(BOLD)ðŸ“Š Running tests with coverage...$(NC)"
	python -m pytest tests/ -v --cov=. --cov-report=html --cov-report=term

# ===================================================================
# ðŸš€ CI/CD COMMANDS
# ===================================================================

ci: ## ðŸš€ Run full CI/CD pipeline locally
	@echo "$(BOLD)ðŸš€ Running full CI/CD pipeline...$(NC)"
	python run_local_ci.py

ci-tests: ## ðŸ§ª Run only CI/CD test jobs
	@echo "$(BOLD)ðŸ§ª Running CI/CD test jobs...$(NC)"
	python run_local_ci.py --tests-only

ci-job: ## ðŸŽ¯ Run specific CI/CD job (usage: make ci-job JOB=job-name)
	@echo "$(BOLD)ðŸŽ¯ Running CI/CD job: $(JOB)$(NC)"
	python run_local_ci.py --job $(JOB)

ci-list: ## ðŸ“‹ List available CI/CD jobs
	@echo "$(BOLD)ðŸ“‹ Available CI/CD jobs:$(NC)"
	python run_local_ci.py --list

ci-dry-run: ## ðŸ” Run CI/CD pipeline in dry-run mode
	@echo "$(BOLD)ðŸ” Running CI/CD pipeline (dry-run)...$(NC)"
	python run_local_ci.py --dry-run

# ===================================================================
# ðŸ”§ SETUP AND ENVIRONMENT
# ===================================================================

setup: ## ðŸ”§ Setup development environment
	@echo "$(BOLD)ðŸ”§ Setting up development environment...$(NC)"
	python run_local_ci.py --setup
	@echo "$(GREEN)âœ… Setup complete!$(NC)"

setup-test: ## ðŸ§ª Run setup validation tests
	@echo "$(BOLD)ðŸ§ª Running setup validation...$(NC)"
	python test_setup.py

validate: ## âœ… Validate configuration
	@echo "$(BOLD)âœ… Validating configuration...$(NC)"
	python validate_config.py

# ===================================================================
# ðŸ³ DOCKER COMMANDS
# ===================================================================

docker-build: ## ðŸ³ Build Docker training image
	@echo "$(BOLD)ðŸ³ Building Docker training image...$(NC)"
	docker build -f Dockerfile.training -t mlflow-training-local .

docker-test: ## ðŸ§ª Test Docker setup
	@echo "$(BOLD)ðŸ§ª Testing Docker setup...$(NC)"
	docker-compose -f docker-compose.local.yml config
	@echo "$(GREEN)âœ… Docker configuration valid$(NC)"

docker-up: ## ðŸš€ Start MLflow services
	@echo "$(BOLD)ðŸš€ Starting MLflow services...$(NC)"
	docker-compose -f docker-compose.local.yml up -d

docker-down: ## ðŸ›‘ Stop MLflow services
	@echo "$(BOLD)ðŸ›‘ Stopping MLflow services...$(NC)"
	docker-compose -f docker-compose.local.yml down

docker-logs: ## ðŸ“‹ Show Docker logs
	@echo "$(BOLD)ðŸ“‹ Docker logs:$(NC)"
	docker-compose -f docker-compose.local.yml logs

# ===================================================================
# ðŸ§¹ CLEANUP COMMANDS
# ===================================================================

clean: ## ðŸ§¹ Clean up temporary files and artifacts
	@echo "$(BOLD)ðŸ§¹ Cleaning up...$(NC)"
	python run_local_ci.py --clean
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf coverage.xml
	@echo "$(GREEN)âœ… Cleanup complete!$(NC)"

clean-docker: ## ðŸ³ Clean up Docker containers and images
	@echo "$(BOLD)ðŸ³ Cleaning up Docker...$(NC)"
	docker-compose -f docker-compose.local.yml down -v
	docker system prune -f
	@echo "$(GREEN)âœ… Docker cleanup complete!$(NC)"

# ===================================================================
# ðŸŽ¯ TRAINING COMMANDS
# ===================================================================

train: ## ðŸŽ¯ Run training pipeline
	@echo "$(BOLD)ðŸŽ¯ Running training pipeline...$(NC)"
	python run_training.py train

train-build: ## ðŸ”¨ Build training container
	@echo "$(BOLD)ðŸ”¨ Building training container...$(NC)"
	python run_training.py build

# ===================================================================
# ðŸ“Š REPORTING COMMANDS
# ===================================================================

report: ## ðŸ“Š Generate test and coverage reports
	@echo "$(BOLD)ðŸ“Š Generating reports...$(NC)"
	python -m pytest tests/ --cov=. --cov-report=html --cov-report=xml
	@echo "$(GREEN)âœ… Reports generated:$(NC)"
	@echo "  - HTML Coverage: htmlcov/index.html"
	@echo "  - XML Coverage: coverage.xml"

# ===================================================================
# ðŸš€ QUICK COMMANDS
# ===================================================================

quick-test: ## âš¡ Quick test (unit tests only, no coverage)
	@echo "$(BOLD)âš¡ Running quick tests...$(NC)"
	python -m pytest tests/unit/ -v --tb=short

quick-ci: ## âš¡ Quick CI (tests only, no Docker)
	@echo "$(BOLD)âš¡ Running quick CI...$(NC)"
	python run_local_ci.py --tests-only

all: clean setup test ci ## ðŸŽ¯ Run complete workflow (clean, setup, test, ci)
	@echo "$(BOLD)$(GREEN)ðŸŽ‰ Complete workflow finished!$(NC)"

# ===================================================================
# ðŸ“ DEVELOPMENT HELPERS
# ===================================================================

install-act: ## ðŸ“¦ Install Act (GitHub Actions runner)
	@echo "$(BOLD)ðŸ“¦ Installing Act...$(NC)"
	@echo "Please install Act manually from: https://github.com/nektos/act#installation"
	@echo "Or use one of these methods:"
	@echo "  - macOS: brew install act"
	@echo "  - Linux: curl https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash"
	@echo "  - Windows: choco install act-cli"

status: ## ðŸ“Š Show project status
	@echo "$(BOLD)ðŸ“Š Project Status$(NC)"
	@echo "=================="
	@echo "$(BLUE)Python Version:$(NC) $$(python --version)"
	@echo "$(BLUE)Docker Status:$(NC) $$(docker --version 2>/dev/null || echo 'Not installed')"
	@echo "$(BLUE)Act Status:$(NC) $$(act --version 2>/dev/null || echo 'Not installed')"
	@echo "$(BLUE)MLflow Status:$(NC) $$(curl -s http://localhost:5005 >/dev/null && echo 'Running' || echo 'Not running')"
	@echo "$(BLUE)Test Files:$(NC) $$(find tests/ -name '*.py' | wc -l) files"
	@echo "$(BLUE)Config Valid:$(NC) $$(python validate_config.py >/dev/null 2>&1 && echo 'Yes' || echo 'No')"
