# ðŸš€ MLflow Local CI/CD Makefile
# 
# This Makefile provides convenient commands for running tests,
# CI/CD pipeline, and development tasks locally.
#
# Usage:
#   make help          # Show this help
#   make test          # Run all tests
#   make train         # Run training
#   make setup         # Setup development environment

.PHONY: help test unit-test integration-test train setup clean lint format docker-test build-training build-training-in-prefect retag-training-image

# Default target
.DEFAULT_GOAL := help

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
BOLD := \033[1m
NC := \033[0m # No Color

help: ## ðŸ“‹ Show this help message
	@echo "$(BOLD)ðŸš€ MLflow Local CI/CD Commands$(NC)"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(BLUE)%-20s$(NC) %s\n", $$1, $$2}'

# ===================================================================
# ðŸ§ª TESTING COMMANDS
# ===================================================================

test: ## ðŸ§ª Run all tests (unit + integration)
	@echo "$(BOLD)ðŸ§ª Running all tests...$(NC)"
	python -m pytest tests/ -v

unit-test: ## ðŸ”¬ Run unit tests only
	@echo "$(BOLD)ðŸ”¬ Running unit tests...$(NC)"
	python -m pytest tests/unit/ -v

integration-test: ## ðŸ”— Run integration tests only
	@echo "$(BOLD)ðŸ”— Running integration tests...$(NC)"
	python -m pytest tests/integration/ -v

test-coverage: ## ðŸ“Š Run tests with coverage report
	@echo "$(BOLD)ðŸ“Š Running tests with coverage...$(NC)"
	python -m pytest tests/ -v --cov=. --cov-report=html --cov-report=term

# ===================================================================
# ðŸŽ¯ TRAINING COMMANDS
# ===================================================================

train: ## ðŸŽ¯ Run training pipeline
	@echo "$(BOLD)ðŸŽ¯ Running training pipeline...$(NC)"
	python scripts/run_training.py train

train-build: ## ðŸ”¨ Build training container
	@echo "$(BOLD)ðŸ”¨ Building training container...$(NC)"
	python scripts/run_training.py build

train-cleanup: ## ðŸ§¹ Clean up training containers
	@echo "$(BOLD)ðŸ§¹ Cleaning up training containers...$(NC)"
	python scripts/run_training.py cleanup

# ===================================================================
# ðŸ³ DOCKER COMMANDS
# ===================================================================

docker-build: ## ðŸ³ Build Docker training image
	@echo "$(BOLD)ðŸ³ Building Docker training image...$(NC)"
	docker-compose -f config/docker-compose.local.yml build training

docker-test: ## ðŸ§ª Test Docker setup
	@echo "$(BOLD)ðŸ§ª Testing Docker setup...$(NC)"
	docker-compose -f config/docker-compose.local.yml config
	@echo "$(GREEN)âœ… Docker configuration valid$(NC)"

docker-up: ## ðŸš€ Start MLflow services
	@echo "$(BOLD)ðŸš€ Starting MLflow services...$(NC)"
	docker-compose -f config/docker-compose.local.yml up -d mlflow-mysql mlflow

docker-down: ## ðŸ›‘ Stop MLflow services
	@echo "$(BOLD)ðŸ›‘ Stopping MLflow services...$(NC)"
	docker-compose -f config/docker-compose.local.yml down

docker-logs: ## ðŸ“‹ Show Docker logs
	@echo "$(BOLD)ðŸ“‹ Docker logs:$(NC)"
	docker-compose -f config/docker-compose.local.yml logs

# ===================================================================
# ðŸ§¹ CLEANUP COMMANDS
# ===================================================================

clean: ## ðŸ§¹ Clean up temporary files and artifacts
	@echo "$(BOLD)ðŸ§¹ Cleaning up...$(NC)"
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf coverage.xml
	@echo "$(GREEN)âœ… Cleanup complete!$(NC)"

clean-docker: ## ðŸ³ Clean up Docker containers and images
	@echo "$(BOLD)ðŸ§¹ Cleaning up Docker...$(NC)"
	docker-compose -f config/docker-compose.local.yml down -v
	docker system prune -f
	@echo "$(GREEN)âœ… Docker cleanup complete!$(NC)"

# ===================================================================
# ðŸ“Š REPORTING COMMANDS
# ===================================================================

report: ## ðŸ“Š Generate test and coverage reports
	@echo "$(BOLD)ðŸ“Š Generating reports...$(NC)"
	python -m pytest tests/ --cov=. --cov-report=html --cov-report=xml
	@echo "$(GREEN)âœ… Reports generated:$(NC)"
	@echo "  - HTML Coverage: htmlcov/index.html"
	@echo "  - XML Coverage: coverage.xml"

# ===================================================================
# ðŸš€ QUICK COMMANDS
# ===================================================================

quick-test: ## âš¡ Quick test (unit tests only, no coverage)
	@echo "$(BOLD)âš¡ Running quick tests...$(NC)"
	python -m pytest tests/unit/ -v --tb=short

health-check: ## ðŸ” Run health checks
	@echo "$(BOLD)ðŸ” Running health checks...$(NC)"
	python scripts/check_health.py

all: clean test train ## ðŸŽ¯ Run complete workflow (clean, test, train)
	@echo "$(BOLD)$(GREEN)ðŸŽ‰ Complete workflow finished!$(NC)"

# ===================================================================
# ðŸ“ DEVELOPMENT HELPERS
# ===================================================================

status: ## ðŸ“Š Show project status
	@echo "$(BOLD)ðŸ“Š Project Status$(NC)"
	@echo "=================="
	@echo "$(BLUE)Python Version:$(NC) $$(python --version)"
	@echo "$(BLUE)Docker Status:$(NC) $$(docker --version 2>/dev/null || echo 'Not installed')"
	@echo "$(BLUE)MLflow Status:$(NC) $$(curl -s http://localhost:5005 >/dev/null && echo 'Running' || echo 'Not running')"
	@echo "$(BLUE)Test Files:$(NC) $$(find tests/ -name '*.py' | wc -l) files"
	@echo "$(BLUE)Training Script:$(NC) src/model_7_local.py"

# Build the training image from the host (recommended for Prefect)
build-training:
	docker compose -f local/config/docker-compose.local.yml build training

# Build the training image inside the Prefect container (advanced/debug)
build-training-in-prefect:
	docker exec -it prefect bash -c 'cd /workspace && docker build -f local/config/Dockerfile.training -t config-training:latest .'

# Retag a custom image as config-training:latest
retag-training-image:
	docker tag test-training config-training:latest
